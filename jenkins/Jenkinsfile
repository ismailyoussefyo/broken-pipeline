pipeline {
    agent any
    
    environment {
        AWS_REGION = 'eu-central-1'
        ECR_REPO = credentials('ecr-repo-url')
        APP_NAME = 'hello-world'
        EMAIL_RECIPIENTS = 'ismailmostafa.y@gmail.com'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building Docker image from Dockerfile...'
                script {
                    // FLAW #2: Missing error handling - if docker build fails, pipeline continues
                    // The Build stage executes Docker commands without checking return codes
                    // If docker build fails, the pipeline continues to the next stage without failing
                    // Impact: Pipeline may report success even when builds fail, leading to deployment of broken images
                    // Fix: Add error checking: docker build ... || exit 1
                    sh '''
                        echo "=========================================="
                        echo "Building custom Docker image"
                        echo "Dockerfile: ./Dockerfile"
                        echo "Base Image: nginx:alpine"
                        echo "Custom: Welcome page with pipeline info"
                        echo "Build Number: ${BUILD_NUMBER}"
                        echo "=========================================="
                        
                        # Build custom image from Dockerfile
                        docker build -f Dockerfile -t ${APP_NAME}:${BUILD_NUMBER} .
                        
                        echo ""
                        echo "Image built successfully!"
                        echo "Tagging images for ECR..."
                        
                        # Tag for ECR with build number and latest
                        docker tag ${APP_NAME}:${BUILD_NUMBER} ${ECR_REPO}:${BUILD_NUMBER}
                        docker tag ${APP_NAME}:${BUILD_NUMBER} ${ECR_REPO}:latest
                        
                        echo ""
                        echo "Images tagged:"
                        docker images | grep ${APP_NAME} | head -3
                        echo "=========================================="
                    '''
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running tests...'
                script {
                    // Run health check script
                    sh 'bash scripts/verify_health.sh ${APP_NAME}:${BUILD_NUMBER}'
                }
            }
        }
        
        stage('Push to ECR') {
            steps {
                echo 'Pushing image to ECR...'
                script {
                    withCredentials([
                        string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
                        string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        sh '''
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO}
                            docker push ${ECR_REPO}:${BUILD_NUMBER}
                            docker push ${ECR_REPO}:latest
                        '''
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'Deploying to ECS...'
                script {
                    withCredentials([
                        string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
                        string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        sh '''
                            aws ecs update-service \
                                --cluster broken-pipeline-app \
                                --service broken-pipeline-app-service \
                                --force-new-deployment \
                                --region ${AWS_REGION}
                        '''
                    }
                }
            }
        }
        
        stage('Verify') {
            steps {
                echo 'Verifying deployment...'
                script {
                    sh 'sleep 30'
                    sh 'bash scripts/verify_health.sh ${ECR_REPO}:latest'
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed'
            // Cleanup
            sh 'docker system prune -f'
        }
        success {
            echo 'Pipeline succeeded!'
            emailext (
                subject: "‚úÖ Pipeline SUCCESS: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                body: """
                    <h2>Pipeline Execution Successful! üéâ</h2>
                    
                    <h3>Build Information:</h3>
                    <ul>
                        <li><strong>Job Name:</strong> ${env.JOB_NAME}</li>
                        <li><strong>Build Number:</strong> ${env.BUILD_NUMBER}</li>
                        <li><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></li>
                        <li><strong>Console Output:</strong> <a href="${env.BUILD_URL}console">${env.BUILD_URL}console</a></li>
                    </ul>
                    
                    <h3>Pipeline Stages Completed:</h3>
                    <ul>
                        <li>‚úÖ Checkout - Source code pulled from Git</li>
                        <li>‚úÖ Build - Docker image built successfully</li>
                        <li>‚úÖ Test - Health checks passed</li>
                        <li>‚úÖ Push to ECR - Image pushed to repository</li>
                        <li>‚úÖ Deploy - Deployed to ECS cluster</li>
                        <li>‚úÖ Verify - Deployment verified</li>
                    </ul>
                    
                    <h3>Deployment Details:</h3>
                    <p>‚úÖ Successfully deployed to ECS cluster: <strong>broken-pipeline-app</strong></p>
                    <p>‚úÖ Service updated: <strong>broken-pipeline-app-service</strong></p>
                    
                    <hr>
                    <p><em>This is an automated email from Jenkins CI/CD Pipeline</em></p>
                """,
                to: "${env.EMAIL_RECIPIENTS}",
                mimeType: 'text/html'
            )
        }
        failure {
            echo 'Pipeline failed!'
            emailext (
                subject: "‚ùå Pipeline FAILURE: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                body: """
                    <h2>Pipeline Execution Failed! ‚ö†Ô∏è</h2>
                    
                    <h3>Build Information:</h3>
                    <ul>
                        <li><strong>Job Name:</strong> ${env.JOB_NAME}</li>
                        <li><strong>Build Number:</strong> ${env.BUILD_NUMBER}</li>
                        <li><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></li>
                        <li><strong>Console Output:</strong> <a href="${env.BUILD_URL}console">${env.BUILD_URL}console</a></li>
                    </ul>
                    
                    <h3>Action Required:</h3>
                    <ol>
                        <li>Check the <a href="${env.BUILD_URL}console">console output</a> for error details</li>
                        <li>Review AWS credentials and permissions</li>
                        <li>Verify Docker image build succeeded</li>
                        <li>Check ECR repository access</li>
                        <li>Verify ECS cluster and service status</li>
                    </ol>
                    
                    <h3>Common Issues:</h3>
                    <ul>
                        <li>Docker build failures (Flaw #2: Missing error handling)</li>
                        <li>Health check failures (Flaw #3: Incomplete verification)</li>
                        <li>AWS credential/permission issues</li>
                        <li>ECR push failures</li>
                        <li>ECS deployment errors</li>
                    </ul>
                    
                    <hr>
                    <p><em>This is an automated email from Jenkins CI/CD Pipeline</em></p>
                """,
                to: "${env.EMAIL_RECIPIENTS}",
                mimeType: 'text/html'
            )
        }
        unstable {
            echo 'Pipeline unstable!'
            emailext (
                subject: "‚ö†Ô∏è  Pipeline UNSTABLE: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                body: """
                    <h2>Pipeline Execution Unstable ‚ö†Ô∏è</h2>
                    
                    <h3>Build Information:</h3>
                    <ul>
                        <li><strong>Job Name:</strong> ${env.JOB_NAME}</li>
                        <li><strong>Build Number:</strong> ${env.BUILD_NUMBER}</li>
                        <li><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></li>
                        <li><strong>Console Output:</strong> <a href="${env.BUILD_URL}console">${env.BUILD_URL}console</a></li>
                    </ul>
                    
                    <p>The pipeline completed but some tests or checks were unstable.</p>
                    <p>Please review the console output to identify issues.</p>
                    
                    <hr>
                    <p><em>This is an automated email from Jenkins CI/CD Pipeline</em></p>
                """,
                to: "${env.EMAIL_RECIPIENTS}",
                mimeType: 'text/html'
            )
        }
    }
}

