pipeline {
    agent any
    
    environment {
        AWS_REGION = 'eu-central-1'
        ECR_REPO = credentials('ecr-repo-url')
        APP_NAME = 'hello-world'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building Docker image...'
                script {
                    // FLAW #2: Missing error handling - if docker build fails, pipeline continues
                    // The Build stage executes Docker commands without checking return codes
                    // If docker build fails, the pipeline continues to the next stage without failing
                    // Impact: Pipeline may report success even when builds fail, leading to deployment of broken images
                    // Fix: Add error checking: docker build ... || exit 1
                    sh '''
                        docker build -t ${APP_NAME}:${BUILD_NUMBER} .
                        docker tag ${APP_NAME}:${BUILD_NUMBER} ${ECR_REPO}:${BUILD_NUMBER}
                        docker tag ${APP_NAME}:${BUILD_NUMBER} ${ECR_REPO}:latest
                    '''
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running tests...'
                script {
                    // Run health check script
                    sh 'bash scripts/verify_health.sh ${APP_NAME}:${BUILD_NUMBER}'
                }
            }
        }
        
        stage('Push to ECR') {
            steps {
                echo 'Pushing image to ECR...'
                script {
                    withCredentials([aws(credentialsId: 'aws-credentials', variable: 'AWS_CREDENTIALS')]) {
                        sh '''
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO}
                            docker push ${ECR_REPO}:${BUILD_NUMBER}
                            docker push ${ECR_REPO}:latest
                        '''
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'Deploying to ECS...'
                script {
                    withCredentials([aws(credentialsId: 'aws-credentials', variable: 'AWS_CREDENTIALS')]) {
                        sh '''
                            aws ecs update-service \
                                --cluster broken-pipeline-app \
                                --service broken-pipeline-app-service \
                                --force-new-deployment \
                                --region ${AWS_REGION}
                        '''
                    }
                }
            }
        }
        
        stage('Verify') {
            steps {
                echo 'Verifying deployment...'
                script {
                    sh 'sleep 30'
                    sh 'bash scripts/verify_health.sh ${ECR_REPO}:latest'
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed'
            // Cleanup
            sh 'docker system prune -f'
        }
        success {
            echo 'Pipeline succeeded!'
            emailext (
                subject: "Pipeline SUCCESS: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "The pipeline ${env.JOB_NAME} build #${env.BUILD_NUMBER} completed successfully.\n\nView the build: ${env.BUILD_URL}",
                to: "${env.EMAIL_RECIPIENTS}",
                mimeType: 'text/html'
            )
        }
        failure {
            echo 'Pipeline failed!'
            emailext (
                subject: "Pipeline FAILURE: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "The pipeline ${env.JOB_NAME} build #${env.BUILD_NUMBER} failed.\n\nView the build: ${env.BUILD_URL}",
                to: "${env.EMAIL_RECIPIENTS}",
                mimeType: 'text/html'
            )
        }
        unstable {
            echo 'Pipeline unstable!'
            emailext (
                subject: "Pipeline UNSTABLE: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "The pipeline ${env.JOB_NAME} build #${env.BUILD_NUMBER} is unstable.\n\nView the build: ${env.BUILD_URL}",
                to: "${env.EMAIL_RECIPIENTS}",
                mimeType: 'text/html'
            )
        }
    }
}

